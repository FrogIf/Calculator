# 整数快速幂

## 基本原理

对于$3^{16}$平凡算法有:

$$
3^{16} \\
= 3 \cdot 3 \cdot 3 \cdot 3 \cdot 3 \cdot 3 \cdot 3 \cdot 3 \cdot 3 \cdot 3 \cdot 3 \cdot 3 \cdot 3 \cdot 3 \cdot 3 \cdot 3 \\
= \dots\\
= 43046721
$$

需要执行16次乘法运算

显然, 平凡算法的运行时间为:$\Theta(n)$


快速幂算法的基本思路是通过二分思想, 降低指数的规模. 并且$a^b$, 需要满足$b\in N$

首先, 对于$3^{16}$, 有:

$$
16 = 2^4\\
3^{16} = (((3^2)^2)^2)^2 = 43046721
$$

只需要进行4次乘法运算.

如果指数中存在奇数, 例如$3^{13}$, 有:

$$
13 = 2^2 + 2^2 + 2^0\\
3^{13} = 3^8 \cdot 3^4 \cdot 3^1 = ((3^2)^2)^2 \cdot (3^2)^2 \cdot 3 = 1594323
$$

这里进行了几次乘法运算呢?

$$
3^2=9 \dots (1次)\\
(3^2)^2 = 81\dots (1次, 因为3^2上一步已经算出来了)\\
((3^2)^2)^2=6561 \dots (1次, 因为(3^2)^2上一步已经算出来了)\\
6561 \cdot 81 \cdot 3 = 1594323 (2次)
$$

所以, 总共执行了5次乘法运算.

下面给出形式化的计算公式:

对于$a^b$, 且$b\in N$, 有

$$
b = 2^{k_n} + 2^{k_{n-1}} + \dots + 2^{k_0}
$$

> 二进制原理

所以:

$$
a^b = a^{2^{k_n}} \cdot a^{2^{k_{n-1}}} \dots a^{2^{k_0}}
$$

并且, 不妨认为:

$$
k_1 < k_2 < k_3 < \dots < k_n
$$

这样, 当我们计算出$a^{2^{k_0}}$时, 就可以在其基础上直接计算出$a^{2^{k_1}}$


## 代码实现

```code
function power(a/*底数*/, b/*指数*/){
    result = 1;
    while(b != 0){
        if(b is odd){
            result = result * a;    // code3
        }
        a = a * a;  // code1
        b = b / 2;  // code2
    }
    return result;
}
```

对于这段代码, 可以找到与上面公式的对应:

1. 首先, code1实际上就是在迭代计算:

$$
(((a^2)^2)^{2\dots})=a^{2^{k_i}}
$$

2. code2就是在缩减指数的规模

3. code3在计算整个幂次的结果, 即$a^b = a^{2^{k_n}} \cdot a^{2^{k_{n-1}}} \dots a^{2^{k_0}}$, 并且只有b是奇数才会执行

下面以$3^{16}$和$3^{13}$为例, 演示代码执行结果:

先是$3^{16}$:

1. 初始值: $result = 1, a = 3, b = 16$
2. $result = 1, a = 3^2 = 9, b = 8$
3. $result = 1, a = 9^2 = 81, b = 4$
4. $result = 1, a = 81^2 = 6561, b = 2$
5. $result = 1, a = 6561^2 = 43046721, b = 1$
6. $result = 1 \times a = 43046721, a = 1853020188851841, b = 0$
7. 结束, 返回$result=43046721$

接下来是$3^{13}$:

1. 初始值: $a = 3, b = 13, result = 1$
2. $result = 1 \times a = 3, a = 3^2 = 9, b = 6$, 这时, $result = 3^1$
3. $result = 3, a = 9^2 = 81, b = 3$
4. $result = 3 \times a = 243, a = 6561, b = 1$, 这时, $result = 3^1 \cdot 3^4$
5. $result = 243 \times a = 1594323, a = 43046721, b = 0$, 这时, $result = 3^1 \cdot 3^4 \cdot 3^8$
6. 结束, 返回$result=1594323$


由于, 每次指数规模减半, 所以, 假设每次循环内至多执行两次乘法运算, 所以, 快速幂算法的运行时间为$\Theta(lgn)$